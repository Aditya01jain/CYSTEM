"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const n=require("../../../utilities/constants.cjs"),u=require("../../../utilities/shared.cjs"),o=require("../../../utilities/aria-utils.cjs"),a=require("./variables.cjs"),h=require("./utils.cjs"),f=require("radash");class b{constructor(e,t){this.el=e,this.initOptions(t),this.parent="scroll",this.lastFocus=null,this.isFocused=!1,this.initBindListeners(),this.initObserver(),this.initKeyStrokes(),this.init()}initOptions(e={}){this.options={stopPropagation:!0,...e||{}},u.detectBrowser()==="safari"&&(this.options.preventEvents=!0)}initKeyStrokes(){this.keyStroke=new Map,this.keyMap={ct:this.focusColSelector.bind(this)}}init(){this.initEvents()}initTable(){if(!u.isHTMLElement(this.el))return;const e=this.el.querySelector(".el-table__header-wrapper"),t=this.el.querySelector(".el-table__body-wrapper");this.scrollHeaders=this.getHeaders(e),this.scrollRows=this.getRows(t),this.initInitalFocus(),this.initSelectors()}initInitalFocus(){const e=this.scrollHeaders[0];this.scrollHeaders?.length&&this.initScrollElement(),this.initialFocus&&this.initialFocus!==e?this.initialFocus.removeAttribute("tabindex"):e instanceof HTMLElement&&(this.initialFocus=e,e?.setAttribute("tabindex",0))}initObserver(){this.observer=new MutationObserver(this.observable.bind(this)),this.observer.observe(this.el,{childList:!0,subtree:!0})}initDebounce(){if(this.debouncer)this.debouncer.cancel();else{const e=this.options?.debounceTimer||a.DEBOUNCE_INTERVAL;this.debouncer=f.debounce({delay:e},()=>this.initTable())}this.debouncer()}removeDebounce(){this.debouncer?.cancel(),this.debouncer=nul}observable(e){let{targetFunc:t}=this.options?.observer||{},s=!1;e.some(i=>(t&&(s=t(i)),i.addedNodes?.length||i?.removedNodes?.length||s))&&this.initDebounce()}addAriaAttrs(e){if(this.isFocused)return;o.default.preventEvents(e);let t=a.ALLY_TEXT.common;u.detectOS()==="windows"&&(t=a.ALLY_TEXT.windows+t);let s;Array.from(this.el.querySelectorAll(".el-table__header, .el-table__body")).forEach((l,r)=>{s=r<2?a.ALLY_TEXT.scroll:a.ALLY_TEXT.fixed,l.setAttribute("aria-label",[s,t].join(", "))}),this.isFocused=!0}initScrollElement(){this.scrollHeaders?.[0]?.hasAttribute("tabindex")||this.scrollHeaders?.[0]?.setAttribute("tabindex",0)}initBindListeners(){this.handleNodeDownKey=this.handleNodeDownKey.bind(this),this.initTableEvent=this.initTableEvent.bind(this)}initTableEvent(e){const t=e?.target;if(this.el.contains(t)||t===this.el)return o.default.preventEvents(e),e?.stopImmediatePropagation(),setTimeout(()=>{this.setNodeFocus(this.initialFocus)},100),!0}initSelectors(){this.colSelector=this.el.querySelector(".cyw-column-selector-btn"),this.bindSelectorListener(this.colSelector)}bindSelectorListener(e,t="add"){e instanceof HTMLElement&&e?.[`${t}EventListener`]("keydown",this.handleNodeDownKey)}handleNodeDownKey(e){if((e?.which||e?.keyCode)===n.KEYBOARD_EVENTS?.DOWN){if(!this.scrollRows?.length)return;o.default.preventEvents(e);const s=this.scrollRows?.[0]?.children;if(s?.length){const i=s[s.length-1];this.setNodeFocus(i)}}}initEvents(){this.handleKeyEvent=this.handleKeyEvent.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),this.addAriaAttrs=this.addAriaAttrs.bind(this),this.el.addEventListener("keydown",this.handleKeyEvent),this.el.addEventListener("keyup",this.handleKeyUp),this.el.addEventListener("focusin",this.addAriaAttrs)}reset(){this.el.removeEventListener("keydown",this.handleKeyEvent),this.el.removeEventListener("keyup",this.handleKeyUp),this.el.removeEventListener("focusin",this.addAriaAttrs),this.bindSelectorListener(this.colSelector,"remove"),this.observer?.disconnect(),this.isFocused=!1,this.removeDebounce()}getHeaders(e){return Array.from(e?.querySelectorAll(".el-table__header th:not(.is-hidden)")||[]).filter(t=>h.isNodeVisible(t))}getRows(e){return Array.from(e?.querySelectorAll(".cyw-table-row")||[]).map((t,s)=>(t.setAttribute("rowIndex",s),t))}isHeader(e){return e.parentElement.classList.contains("column-header")||e.nodeName==="TH"?!0:h.getElementByParent(e)!==null}getRowIndex(e){if(!e)return;let s=h.getElementByParent(e,"TR")?.getAttribute("rowIndex");return parseInt(s)}getColumnIndex(e,t=!1){if(!e)return;const{classList:s}=e,l=Array.from(s||[]).find(c=>(c||"").startsWith("cyw-table-column-"))?.split("-");let r;return l?.length?parseInt(l[l.length-1]):(r=h.getElementByParent(e,t?"TH":"TD"),this.getColumnIndex(r))}getNextVisibleScrollNode(e,t=0){let s=t;if(!e?.length)return;let i=e?.[s];for(;s<e?.length-1&&!h.isNodeVisible(i,!1);)i=e[++s];return i}getNextTable(e,t){if(t)return this.scrollHeaders[0];{const s=this.getRowIndex(e);return this.getNextVisibleScrollNode(this.scrollRows?.[s]?.children)}}handleEnter({target:e}){if(this.isHeader(e))return;const t=this.getRowIndex(e);this.scrollRows[t]?.click()}handleLeftRight(e,t){const s=e.which||e.keyCode;e.target===this.colSelector&&s===n.KEYBOARD_EVENTS.LEFT&&(this.colSelector.removeAttribute("tabindex"),this.setNodeFocus(this.scrollHeaders[this.scrollHeaders.length-1],e));const i=this.isHeader(e.target),l=h.getElementByParent(e.target,i?"TH":"TD");l&&this.focusLeftRightNode(l,e,{type:t,isHeader:i})}isColumnSelector(e,t){if(!o.getAttribute(this.el,"data-col-selector")||![e?.which,e?.keyCode].includes(n.KEYBOARD_EVENTS.RIGHT))return!1;const s=this.scrollHeaders?.length-1||0;let i=s>0?this.scrollHeaders[s-1]:null;return!t||this.lastFocus&&this.lastFocus===i}async focusLeftRightNode(e,t,{type:s,isHeader:i}){let l=e[`${s}ElementSibling`];if(this.isColumnSelector(t,l)&&i){this.focusColSelector(t);return}!h.isNodeVisible(l,i)&&(l=this.getNextTable(l,i)),i?this.heaserScrollFix(l):this.updateColumnNode(l),this.setNodeFocus(l,t)}heaserScrollFix(e){if(!e.classList.contains("el-table-fixed-column--left")){const t=this.el.querySelector(".el-table-fixed-column--left.is-last-column"),s=this.el.querySelector(".el-table__body-wrapper .el-scrollbar__wrap"),i=t?.getBoundingClientRect?.()??{right:0},l=e?.getBoundingClientRect?.()??{left:0};s?.scrollTo?.({behavior:"smooth",left:l.left-i.right})}}handleUpDown(e,t=-1){const s=this.isHeader(e.target);let i=this.getRowIndex(e.target),l=this.getColumnIndex(e.target,s),r=this.scrollRows;if(i=i+t,s&&(i=0),i<0)return this.handleHeaderUpDown(e,{colIndex:l}),!0;if(i>=r?.length)return o.default.preventEvents(e),!0;this.initPreventEvents(e),this.handleRowFocus(r,{rowIndex:i,colIndex:l,isHeader:s})}handleHeaderUpDown(e,{colIndex:t}){let s=this.scrollHeaders||[],i=this.scrollHeaders.length<this.scrollRows[0].children.length;t=t+(i?-1:0),this.setNodeFocus(s[t],e)}handleHeaderUpKey(){const e=Array.from(this.el.querySelectorAll("[data-all-selection]")).find(t=>o.hasWidthHeight(t));document?.activeElement!==e&&o.default.focusFirstDescendant(e)}initPreventEvents(e){let{preventEvents:t=!1}=this.options||{};(this.options?.preventDefault||t)&&e?.preventDefault(),(this.options?.stopPropagation||t)&&e?.stopPropagation()}setNodeFocus(e,t){e instanceof HTMLElement&&(this.initPreventEvents(t),this.lastFocus?.classList?.contains?.("el-table-fixed-column--left")&&t?.preventDefault?.(),e?.setAttribute("tabindex",0),e?.focus(),this.lastFocus&&this.lastFocus!==e&&this.lastFocus?.removeAttribute("tabindex"),this.lastFocus=e)}handleRowFocus(e=[],{rowIndex:t,colIndex:s,isHeader:i=!1}={}){const l=e?.[t]?.children?.length;!e.every(d=>d.children?.length===l)&&s>0&&t>0&&(s=s-1);const c=e[t]?.children?.[s];i||this.updateColumnNode(c),this.setNodeFocus(c)}updateColumnNode(e){e?.classList?.contains(a.SELECTORS.actions.class)&&Object.entries(a.SELECTORS.actions.attributes).forEach(([t,s])=>{e?.setAttribute(t,s)})}focusColSelector(e){o.default.preventEvents(e),this.setNodeFocus(this.colSelector)}handleKeyUp(e){this.keyStroke.set(e.key,!1)}handleKeyEvent(e){const t=e.which||e.keyCode;this.keyStroke.set(e.key,!0);const s=[n.KEYBOARD_EVENTS.LEFT,n.KEYBOARD_EVENTS.RIGHT],i=[n.KEYBOARD_EVENTS.UP,n.KEYBOARD_EVENTS.DOWN];if(s.includes(t))this.handleLeftRight(e,t===n.KEYBOARD_EVENTS.LEFT?"previous":"next");else if(i.includes(t))this.handleUpDown(e,n.KEYBOARD_EVENTS.UP===t?-1:1);else if(n.KEYBOARD_EVENTS.ENTER.includes(t))this.handleEnter(e);else{const r=Array.from(this.keyStroke.entries()).filter(d=>d[1]).map(d=>d[0]);r.sort();const c=r.join("");this.keyMap?.[c]?.(e)}}}exports.default=b;
//# sourceMappingURL=index.cjs.map
