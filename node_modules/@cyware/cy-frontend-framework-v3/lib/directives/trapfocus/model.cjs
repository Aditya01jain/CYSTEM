"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("../../utilities/aria-utils.cjs"),a=require("./trackElement.cjs"),u=require("../../utilities/shared.cjs"),n=require("../../utilities/constants.cjs"),c=require("radash"),f=["select","dropdown","combobox"],b=({key:l,keyCode:t})=>["Escape","Esc"].includes(l)||t===27,p=100,E=100,m=0,F=5,L={childList:!0,subtree:!0,attributes:!1},r=new a.default;class v{constructor(t,s,i){this.el=t,this.elId=u.uuId(),this.initBindListeners(),r.add({id:this.elId,self:this}),this.options=i,this.initNode(s),this.initObserver(),this.initListeners()}initOptions(t={}){this.dataRole=this.el.getAttribute("data-role"),this.options=t,this.skipElements=this.options?.skipElements||[]}initBindListeners(){this.tabEvent=this.tabEvent.bind(this),this.handleKeydown=this.handleKeydown.bind(this),this.handleShiftTab=this.handleShiftTab.bind(this),this.handleTab=this.handleTab.bind(this),this.focusEvent=this.focusEvent.bind(this)}initNode(t){if(!this.el)throw new Error("Dialog() requires a DOM element with ARIA role of dialog.");t instanceof HTMLElement?this.focusAfterClosed=t:this.focusAfterClosed=e.default.findNode(t),this.lastFocus=document.activeElement,this.isInitFocused=!1;let s=1;r.getLength()>1&&(s=r.getLength()),this.focusFirstNode(this.options?.timer||p*s)}initListeners(t="add"){let s=`${t}EventListener`;document[s]("keydown",this.tabEvent,{capture:!0,passive:!1}),this.el.getAttribute("data-skip-focusin")||document[s]("focusin",this.focusEvent,!0),Object.keys(this.options?.keyEvents||{})?.length&&this.el[s]("keydown",this.handleKeydown)}removeLastFocus(){this.focusLast&&this.focusLast?.removeEventListener("keydown",this.handleTab)}removeFirstFocus(){this.focusFirst?.removeEventListener("keydown",this.handleShiftTab)}removeListeners(){this.removeFirstFocus(),this.removeLastFocus(),this.initListeners("remove")}initObserverAttributes(){let{observer:t}=this.options||{},s={...L};return t&&Object.entries(t||{})?.forEach(([i,o])=>{s?.hasOwnProperty(i)&&(s[i]=o)}),s}initObserver(){this.observer=new MutationObserver(this.observable.bind(this)),this.observer?.observe(this.el,this.initObserverAttributes())}initDebounce(){if(this.debouncer)this.debouncer.cancel();else{const t=this.options?.debounceTimer||E;this.debouncer=c.debounce({delay:t},()=>{let{first:s,last:i}=e.default.findEndNodes(this.el);this.initSkipOptions(),this.focusLast!==i&&(this.removeLastFocus(),this.focusLast=i,this.addLastFocusListener()),s&&this.focusFirst!==s&&(this.removeFirstFocus(),this.focusFirst=s,this.addFirstFocusListener())})}this.debouncer()}initSkipOptions(){this.skipElements=this.options?.skipElements||[],this.options?.modalBodyElement&&this.skipElements.push(...Array.from(document.querySelectorAll('[data-popup-node="true"]')))}handleTab(t){t?.target===this.focusLast&&(n.isTab(t)||n.isCtrlAltRight(t))&&(e.default.preventEvents(t),this.initFocusFirst())}removeDebounce(){this.debouncer?.cancel(),this.debouncer=null}observable(t){let{targetFunc:s}=this.options?.observer||{},i=!1;t.some(o=>(s&&(i=s(o)),o.addedNodes?.length||o?.removedNodes?.length||i))&&this.initDebounce()}addLastFocusListener(t=this.focusLast){t&&t?.addEventListener("keydown",this.handleTab)}addFirstFocusListener(t=this.focusFirst){t?.addEventListener("keydown",this.handleShiftTab)}handleShiftTab(t){t?.target===this.focusFirst&&(n.isShiftTab(t)||n.isCtrlAltLeft(t)||!this.focusLast&&(n.isTab(t)||n.isCtrlAltRight(t)))&&(e.default.preventEvents(t),e.default.focusLastDescendant(this.el))}removeObserver(){this.observer?.disconnect(),this.observer=null}close(){r.remove(this.elId),this.removeListeners(),this.removeDebounce(),this.removeObserver(),this.elId=null,this.lastFocus=null,this.focusLast=null,this.focusFirst=null,!this.options?.skipAfterClosed&&this.focusAfterClosed&&this.handleClose()}handleClose(){let t=this.focusAfterClosed;const s=e.default.isElementVisible(t);!s&&this.trackElements?.length>0||setTimeout(()=>{s||(t=this.findClosestTabbable(t)),t!==document.activeElement&&e.default.attemptFocus(t)},this.options?.closeTimer||m)}findClosestTabbable(t){const s=this.options?.maxTraversal||F;let i=0,o=t.parentNode?.closest(`${e.TAB_SELECTOR}`);if(!o){const d=t.closest("[data-popper]")?.getAttribute("data-popper"),h=e.default.findNode(`[id="${d}"]`,document.body);if(e.default.isElementVisible(h))return h}for(;!e.default.isElementVisible(o)&&o&&!(i>=s);)o=o.closest(e.TAB_SELECTOR),i++;return o||document.body}initNodes(){let t=e.default.findEndNodes(this.el);this.focusLast=t?.last,this.focusFirst=t?.first}focusFirstNode(t){setTimeout(()=>{this.initNodes(),this.addFirstFocusListener(),this.addLastFocusListener(),this.options?.skipInitFocus||this.initFocusFirst(this.getInitialFocus())},t)}initFocusFirst(t=this.focusFirst){let s=!1;t&&(s=e.default.attemptFocus(t)),s||e.default.focusFirstDescendant(this.el)}getInitialFocus(){let t=this.focusFirst;if(!this.isInitFocused){const{focusFirst:s}=this.options;s?.length&&(t=e.default.findNode(s,this.el)),t instanceof HTMLElement||(t=this.focusFirst)}return t}handleInitFocus(t){n.isTab(t)||n.isCtrlAltRight(t)?(t?.stopPropagation(),this.initFocusFirst(this.getInitialFocus())):(n.isShiftTab(t)||n.isCtrlAltLeft(t))&&(t?.stopPropagation(),e.default.focusLastDescendant(this.el))}isTargetContained(t){const s=window.getSelection();return s?.toString()?.length&&!f.includes(this.dataRole)&&(t=s?.focusNode?.parentNode),(this.skipElements?.some(i=>i.contains(t))||this.el.contains(t))&&![document,document.body].includes(t)}focusEvent(t){if(!r?.isTopNode(this.elId))return;const{target:s}=t;this.isTargetContained(s)?this.el.contains(s)&&(this.lastFocus=s):(e.default.preventEvents(t),this.lastFocus!==s&&e.default.attemptFocus(this.focusFirst))}tabEvent(t){if(!r?.isTopNode(this.elId))return;const{target:s}=t;if(!this.el.contains(s)||[document,document.body].includes(s)){if(b(t)){e.default.preventEvents(t),this.handleKeydown(t);return}this.handleInitFocus(t)}}handleKeydown(t){const s=t?.keyCode||t?.which,i=n.KEY_MAP?.[t.key]||s;this.options?.keyEvents?.[i]?.(t)}}exports.default=v;
//# sourceMappingURL=model.cjs.map
