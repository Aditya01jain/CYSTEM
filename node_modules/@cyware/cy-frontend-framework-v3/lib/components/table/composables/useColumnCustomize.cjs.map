{"version":3,"file":"useColumnCustomize.cjs","sources":["../../../../src/components/table/composables/useColumnCustomize.ts"],"sourcesContent":["import { ColumnConfig } from \"./../types\";\nimport { computed, ComputedRef, onBeforeUnmount, ref } from \"vue\";\nimport sortableJS from \"sortablejs\";\nimport { useDebounce } from \"../../../composables/useDebounce\";\nimport { columnWidth } from \"../utils\";\nimport { RIGHT_OFFSET, SORTABLE_CONFIG } from \"../variables\";\nimport type { CustomizeParams, CustomizeEvents } from \"../types\";\n\nconst TABLE_MAP_KEYS = [\"minwidth\", \"fixed\", \"is_display\", \"key\", \"width\"];\n\nexport default (\n  tableParams: ComputedRef<CustomizeParams>,\n  events: CustomizeEvents\n) => {\n  const params = ref(tableParams);\n  const sortable = ref<sortableJS | null>(null);\n\n  const debouncer = useDebounce({\n    triggers: {\n      customize: {\n        trigger: debounceCustomization,\n        timer: 1000\n      }\n    }\n  });\n  const columnLoading = ref(false);\n\n  onBeforeUnmount(() => {\n    destroySortable();\n  });\n\n  const dataColumns = computed(() => {\n    const keys = (params.value.sorted || []).map((data) => data.key);\n    return params.value.columns.map((data) => {\n      return { ...data, is_display: keys.includes(data.key) };\n    });\n  });\n\n  function initDebounce() {\n    debouncer.initDebounce(\"customize\");\n  }\n\n  const init = async () => {\n    if (params.value.tableConfig.customizable) {\n      if (!params.value.tableConfig?.localizeCustomization)\n        await getCustomization();\n      else initDraggable();\n    }\n  };\n\n  async function debounceCustomization() {\n    const { tableConfig, events: tableEvents, sorted } = params.value;\n    init();\n    if (\n      !tableConfig?.localizeCustomization &&\n      typeof tableEvents?.dragInit === \"function\"\n    )\n      tableEvents?.dragInit({\n        component: tableConfig.customizeSlug || \"\",\n        config: JSON.stringify(getDataModel())\n      });\n    else events.$emits(\"customize\", sorted);\n    events.initExpander();\n  }\n\n  const getDataModel = () => {\n    const { listColumns, tableConfig, sorted } = params.value;\n    const rightColumns = listColumns.right.filter((data) => !data.is_display);\n    const { emitColumnData = false } = tableConfig;\n    const columns = sorted.concat(rightColumns);\n    return columns.reduce((result: ColumnConfig[], column: ColumnConfig) => {\n      if (column.hideFromConfig) return result;\n      return result.concat(\n        emitColumnData\n          ? column\n          : TABLE_MAP_KEYS.reduce(\n              (result: ColumnConfig, key: keyof ColumnConfig) => {\n                if (column.hasOwnProperty(key)) result[key] = column[key];\n                return result;\n              },\n              {} as ColumnConfig\n            )\n      );\n    }, []);\n  };\n\n  const getOrderedColumn = (list: ColumnConfig[], columns: ColumnConfig[]) => {\n    let rest: { [key: string]: ColumnConfig[] } = {\n      left: [],\n      right: [],\n      middle: []\n    };\n    list.forEach((column) => {\n      if (\n        !columns.some((data) => data.key === column.key) &&\n        column.is_display\n      ) {\n        const key = column.hideFromConfig ? \"left\" : \"right\";\n        rest[key].push(column);\n      }\n    });\n    columns.forEach((column) => {\n      let find = list.find((data) => data.key === column.key);\n      if (find && column.is_display) {\n        find.is_display = true;\n        rest.middle.push({ ...find, ...column });\n      }\n    });\n    return ([] as ColumnConfig[]).concat(rest.left, rest.middle, rest.right);\n  };\n\n  async function getCustomization() {\n    const {\n      columns,\n      tableConfig,\n      appliedSlug,\n      listColumns,\n      events: tableEvents\n    } = params.value;\n    const isColumnCustomizable =\n      !tableConfig.customizable ||\n      columnLoading.value ||\n      (tableConfig?.customizeSlug && appliedSlug === tableConfig.customizeSlug);\n    if (isColumnCustomizable) return;\n    columnLoading.value = true;\n    events.updateConfig(\"customizeSlug\", appliedSlug);\n    let data: { config?: string } = {};\n    if (typeof tableEvents?.dragEnd === \"function\") {\n      data = await tableEvents.dragEnd(appliedSlug);\n    }\n    if (!data?.config) {\n      columnLoading.value = false;\n      return;\n    }\n    const columnsConfig = JSON.parse(data?.config);\n    let result = getOrderedColumn(columns, columnsConfig);\n    listColumns.left = result;\n    events.setColumns(result);\n    columnDrag();\n    columnLoading.value = false;\n  }\n\n  function isDragging(el: HTMLElement) {\n    return el.querySelectorAll(\".noclick\")?.length > 0;\n  }\n\n  function handleMouseMove(event: MouseEvent, element: HTMLElement) {\n    const table = params.value.tableRef.value?.$el;\n    if (!table) return;\n    const tableLeft = table?.getBoundingClientRect()?.left || 0,\n      fixedColumns = Array.from(\n        table.querySelectorAll(\".el-table-fixed-column--left\") as HTMLElement[]\n      ).map((elm: HTMLElement) => {\n        return elm.querySelector(\"[data-key]\")?.getAttribute(\"data-key\");\n      }),\n      thRect = element.getBoundingClientRect(),\n      dataKey = element.getAttribute(\"data-key\"),\n      resize = table.querySelector(\".el-table__column-resize-proxy\");\n    if (!resize) return;\n    if (\n      thRect.width > 12 &&\n      (thRect.right - event.pageX < 8 ||\n        Math.floor(thRect.width) - Math.floor(event.offsetX) < 3) &&\n      !fixedColumns.includes(dataKey)\n    ) {\n      resize.style.display = \"block\";\n      resize.style.width = \"0.1rem\";\n      resize.style.left = `${thRect.right - tableLeft}px`;\n    } else if (!isDragging(table)) resize.style.display = \"none\";\n  }\n\n  function handleMouseOut() {\n    const table = params.value.tableRef.value?.$el;\n    const resize = table?.querySelector?.(\".el-table__column-resize-proxy\");\n    if (!isDragging(table)) resize.style.display = \"none\";\n  }\n\n  function updateEvtIndex(evt: Record<string, string>) {\n    const { oldKey, newKey } = evt;\n    const [oldIndex, newIndex] = [oldKey, newKey].map((key) =>\n      params.value.sorted.findIndex((column) => column.key === key)\n    );\n    return { oldIndex, newIndex };\n  }\n\n  function shuffleListColumns(evt: Record<string, number>) {\n    if (evt.oldIndex && evt.newIndex) {\n      const column = params.value.sorted[evt.oldIndex];\n      const siblingColumn = params.value.sorted[evt.newIndex - 1];\n      let columns = [];\n      let index = -1,\n        newDataIndex = -1;\n      for (let data of params.value.listColumns.left) {\n        index++;\n        if (data.key === column.key) continue;\n        if (siblingColumn && data.key === siblingColumn.key && siblingColumn)\n          newDataIndex = index + 1;\n        columns.push(data);\n      }\n      if (newDataIndex < 0) newDataIndex = params.value.listColumns.left.length;\n      columns.splice(newDataIndex, 0, column);\n      params.value.listColumns.left = columns;\n    }\n  }\n\n  function updateOrder(evt: Record<string, any>, useDataColumns = false) {\n    if (useDataColumns) evt = updateEvtIndex(evt);\n    if (evt.oldIndex && evt.newIndex) {\n      if (evt.oldIndex === evt.newIndex) return;\n      shuffleListColumns(evt);\n      const { sorted } = params.value;\n      const oldHead = sorted[evt.oldIndex];\n      sorted.splice(evt.oldIndex, 1);\n      sorted.splice(evt.newIndex, 0, oldHead);\n      initDebounce();\n    }\n  }\n\n  function columnDrag(leftOffset?: number, reinitSort?: boolean) {\n    if (!params.value.tableConfig.draggable || params.value.isLoading) return;\n    const el = params.value.elRef.value?.querySelector?.(\n      \".el-table__header-wrapper tr\"\n    ) as HTMLElement;\n    if (reinitSort || sortable.value) destroySortable();\n    if (el)\n      sortable.value = sortableJS.create(el, {\n        ...SORTABLE_CONFIG,\n        scrollSensitivity: (leftOffset || 0) + RIGHT_OFFSET,\n        onEnd: (evt) => updateOrder(evt)\n      });\n  }\n\n  function initDraggable(args?: { init?: boolean; reset?: boolean }) {\n    const { init, reset } = args || {};\n    if (params.value.tableConfig.draggable) {\n      const fixedWidth = params.value.sorted?.reduce((result, column) => {\n        if (!column.hasOwnProperty(\"is_display\")) column.is_display = true;\n        if (column.fixed) result += column.minwidth || columnWidth(column.type);\n        return result;\n      }, 0);\n      setTimeout(() => columnDrag(fixedWidth, reset || false), 100);\n    }\n    if (!init) initDebounce();\n  }\n\n  function destroySortable() {\n    if (sortable.value) {\n      sortable.value.destroy();\n      sortable.value = null;\n    }\n  }\n\n  return {\n    columnLoading,\n    dataColumns,\n    getDataModel,\n    getCustomization,\n    init,\n    debounceCustomization,\n    handleMouseMove,\n    handleMouseOut,\n    initDraggable,\n    initDebounce\n  };\n};\n"],"names":["TABLE_MAP_KEYS","useColumnCustomize","tableParams","events","params","ref","sortable","debouncer","useDebounce","debounceCustomization","columnLoading","onBeforeUnmount","destroySortable","dataColumns","computed","keys","data","initDebounce","init","initDraggable","getCustomization","tableConfig","tableEvents","sorted","getDataModel","listColumns","rightColumns","emitColumnData","result","column","key","getOrderedColumn","list","columns","rest","find","appliedSlug","columnsConfig","columnDrag","isDragging","el","handleMouseMove","event","element","table","tableLeft","fixedColumns","elm","thRect","dataKey","resize","handleMouseOut","updateEvtIndex","evt","oldKey","newKey","oldIndex","newIndex","shuffleListColumns","siblingColumn","index","newDataIndex","updateOrder","useDataColumns","oldHead","leftOffset","reinitSort","sortableJS","SORTABLE_CONFIG","RIGHT_OFFSET","args","reset","fixedWidth","columnWidth"],"mappings":"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"}