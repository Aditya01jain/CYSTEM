"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const f=require("vue"),R=require("sortablejs"),L=require("../../../composables/useDebounce.cjs"),T=require("../utils.cjs"),S=require("../variables.cjs"),B=["minwidth","fixed","is_display","key","width"],F=(I,g)=>{const o=f.ref(I),d=f.ref(null),w=L.useDebounce({triggers:{customize:{trigger:b,timer:1e3}}}),c=f.ref(!1);f.onBeforeUnmount(()=>{z()});const k=f.computed(()=>{const e=(o.value.sorted||[]).map(n=>n.key);return o.value.columns.map(n=>({...n,is_display:e.includes(n.key)}))});function m(){w.initDebounce("customize")}const p=async()=>{o.value.tableConfig.customizable&&(o.value.tableConfig?.localizeCustomization?_():await h())};async function b(){const{tableConfig:e,events:n,sorted:t}=o.value;p(),!e?.localizeCustomization&&typeof n?.dragInit=="function"?n?.dragInit({component:e.customizeSlug||"",config:JSON.stringify(C())}):g.$emits("customize",t),g.initExpander()}const C=()=>{const{listColumns:e,tableConfig:n,sorted:t}=o.value,i=e.right.filter(a=>!a.is_display),{emitColumnData:l=!1}=n;return t.concat(i).reduce((a,u)=>u.hideFromConfig?a:a.concat(l?u:B.reduce((r,y)=>(u.hasOwnProperty(y)&&(r[y]=u[y]),r),{})),[])},E=(e,n)=>{let t={left:[],right:[],middle:[]};return e.forEach(i=>{if(!n.some(l=>l.key===i.key)&&i.is_display){const l=i.hideFromConfig?"left":"right";t[l].push(i)}}),n.forEach(i=>{let l=e.find(s=>s.key===i.key);l&&i.is_display&&(l.is_display=!0,t.middle.push({...l,...i}))}),[].concat(t.left,t.middle,t.right)};async function h(){const{columns:e,tableConfig:n,appliedSlug:t,listColumns:i,events:l}=o.value;if(!n.customizable||c.value||n?.customizeSlug&&t===n.customizeSlug)return;c.value=!0,g.updateConfig("customizeSlug",t);let a={};if(typeof l?.dragEnd=="function"&&(a=await l.dragEnd(t)),!a?.config){c.value=!1;return}const u=JSON.parse(a?.config);let r=E(e,u);i.left=r,g.setColumns(r),x(),c.value=!1}function v(e){return e.querySelectorAll(".noclick")?.length>0}function q(e,n){const t=o.value.tableRef.value?.$el;if(!t)return;const i=t?.getBoundingClientRect()?.left||0,l=Array.from(t.querySelectorAll(".el-table-fixed-column--left")).map(r=>r.querySelector("[data-key]")?.getAttribute("data-key")),s=n.getBoundingClientRect(),a=n.getAttribute("data-key"),u=t.querySelector(".el-table__column-resize-proxy");u&&(s.width>12&&(s.right-e.pageX<8||Math.floor(s.width)-Math.floor(e.offsetX)<3)&&!l.includes(a)?(u.style.display="block",u.style.width="0.1rem",u.style.left=`${s.right-i}px`):v(t)||(u.style.display="none"))}function O(){const e=o.value.tableRef.value?.$el,n=e?.querySelector?.(".el-table__column-resize-proxy");v(e)||(n.style.display="none")}function D(e){const{oldKey:n,newKey:t}=e,[i,l]=[n,t].map(s=>o.value.sorted.findIndex(a=>a.key===s));return{oldIndex:i,newIndex:l}}function M(e){if(e.oldIndex&&e.newIndex){const n=o.value.sorted[e.oldIndex],t=o.value.sorted[e.newIndex-1];let i=[],l=-1,s=-1;for(let a of o.value.listColumns.left)l++,a.key!==n.key&&(t&&a.key===t.key&&t&&(s=l+1),i.push(a));s<0&&(s=o.value.listColumns.left.length),i.splice(s,0,n),o.value.listColumns.left=i}}function A(e,n=!1){if(n&&(e=D(e)),e.oldIndex&&e.newIndex){if(e.oldIndex===e.newIndex)return;M(e);const{sorted:t}=o.value,i=t[e.oldIndex];t.splice(e.oldIndex,1),t.splice(e.newIndex,0,i),m()}}function x(e,n){if(!o.value.tableConfig.draggable||o.value.isLoading)return;const t=o.value.elRef.value?.querySelector?.(".el-table__header-wrapper tr");(n||d.value)&&z(),t&&(d.value=R.create(t,{...S.SORTABLE_CONFIG,scrollSensitivity:(e||0)+S.RIGHT_OFFSET,onEnd:i=>A(i)}))}function _(e){const{init:n,reset:t}=e||{};if(o.value.tableConfig.draggable){const i=o.value.sorted?.reduce((l,s)=>(s.hasOwnProperty("is_display")||(s.is_display=!0),s.fixed&&(l+=s.minwidth||T.columnWidth(s.type)),l),0);setTimeout(()=>x(i,t||!1),100)}n||m()}function z(){d.value&&(d.value.destroy(),d.value=null)}return{columnLoading:c,dataColumns:k,getDataModel:C,getCustomization:h,init:p,debounceCustomization:b,handleMouseMove:q,handleMouseOut:O,initDraggable:_,initDebounce:m}};exports.default=F;
//# sourceMappingURL=useColumnCustomize.cjs.map
